
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>annotator_store.models &#8212; django-annotator-store 0.5.0 documentation</title>
    
    <link rel="stylesheet" href="../../_static/style.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '0.5.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head>
  <body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for annotator_store.models</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">collections</span> <span class="k">import</span> <span class="n">OrderedDict</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">uuid</span>
<span class="kn">from</span> <span class="nn">django.apps</span> <span class="k">import</span> <span class="n">apps</span>
<span class="kn">from</span> <span class="nn">django.db</span> <span class="k">import</span> <span class="n">models</span>
<span class="kn">from</span> <span class="nn">django.conf</span> <span class="k">import</span> <span class="n">settings</span>
<span class="kn">from</span> <span class="nn">django.core.exceptions</span> <span class="k">import</span> <span class="n">ObjectDoesNotExist</span>
<span class="kn">from</span> <span class="nn">django.core.urlresolvers</span> <span class="k">import</span> <span class="n">reverse</span>
<span class="kn">from</span> <span class="nn">django.contrib.auth.models</span> <span class="k">import</span> <span class="n">Group</span><span class="p">,</span> <span class="n">User</span>
<span class="kn">from</span> <span class="nn">django.utils.html</span> <span class="k">import</span> <span class="n">format_html</span>
<span class="kn">from</span> <span class="nn">jsonfield</span> <span class="k">import</span> <span class="n">JSONField</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">guardian</span>
    <span class="kn">from</span> <span class="nn">guardian.shortcuts</span> <span class="k">import</span> <span class="n">assign_perm</span><span class="p">,</span> <span class="n">get_objects_for_user</span><span class="p">,</span> \
        <span class="n">get_objects_for_group</span><span class="p">,</span> <span class="n">get_perms_for_model</span><span class="p">,</span> <span class="n">get_perms</span>
    <span class="kn">from</span> <span class="nn">guardian.models</span> <span class="k">import</span> <span class="n">UserObjectPermission</span><span class="p">,</span> <span class="n">GroupObjectPermission</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">guardian</span> <span class="o">=</span> <span class="kc">None</span>
<span class="kn">import</span> <span class="nn">six</span>


<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<span class="n">ANNOTATION_MODEL_NAME</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="s1">&#39;ANNOTATOR_ANNOTATION_MODEL&#39;</span><span class="p">,</span>
    <span class="s2">&quot;annotator_store.Annotation&quot;</span><span class="p">)</span>

<span class="n">ANNOTATION_OBJECT_PERMISSIONS</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="s1">&#39;ANNOTATION_OBJECT_PERMISSIONS&#39;</span><span class="p">,</span>
    <span class="kc">False</span><span class="p">)</span>


<div class="viewcode-block" id="AnnotationQuerySet"><a class="viewcode-back" href="../../codedocs.html#annotator_store.models.AnnotationQuerySet">[docs]</a><span class="k">class</span> <span class="nc">AnnotationQuerySet</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">QuerySet</span><span class="p">):</span>
    <span class="s1">&#39;Custom :class:`~django.models.QuerySet` for :class:`Annotation`&#39;</span>

<div class="viewcode-block" id="AnnotationQuerySet.visible_to"><a class="viewcode-back" href="../../codedocs.html#annotator_store.models.AnnotationQuerySet.visible_to">[docs]</a>    <span class="k">def</span> <span class="nf">visible_to</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return annotations the specified user is allowed to view.</span>
<span class="sd">        Objects are found based on view_annotation permission and</span>

<span class="sd">        annotations; users can access only their own annotations or</span>
<span class="sd">        those where permissions have been granted to a group they belong to.</span>

<span class="sd">        .. Note::</span>
<span class="sd">            Due to the use of :meth:`guardian.shortcuts.get_objects_for_user`,</span>
<span class="sd">            it is recommended to use this method must be used first; it</span>
<span class="sd">            does combine the existing queryset query, but it does not</span>
<span class="sd">            chain as querysets normally do.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># if per-object permissions are enabled, use guardian to find</span>
        <span class="c1"># annotations the current user can view</span>
        <span class="k">if</span> <span class="n">ANNOTATION_OBJECT_PERMISSIONS</span><span class="p">:</span>
            <span class="n">qs</span> <span class="o">=</span> <span class="n">get_objects_for_user</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="s1">&#39;view_annotation&#39;</span><span class="p">,</span>
                                      <span class="n">get_annotation_model</span><span class="p">())</span>
            <span class="c1"># combine the current queryset query, if any, with the newly</span>
            <span class="c1"># created queryset from django guardian</span>
            <span class="n">qs</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">combine</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">,</span> <span class="s1">&#39;AND&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">qs</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># otherwise, return everything or nothing based on django perms</span>
            <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">has_perm</span><span class="p">(</span><span class="s1">&#39;annotator_store.view_annotation&#39;</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># empty queryset if user doesn&#39;t have view permission</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">none</span><span class="p">()</span></div>

<div class="viewcode-block" id="AnnotationQuerySet.visible_to_group"><a class="viewcode-back" href="../../codedocs.html#annotator_store.models.AnnotationQuerySet.visible_to_group">[docs]</a>    <span class="k">def</span> <span class="nf">visible_to_group</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">group</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return annotations the specified group is allowed to view.</span>
<span class="sd">        Objects are found based on view_annotation permission and</span>
<span class="sd">        per-object permissions.</span>

<span class="sd">        .. Note::</span>
<span class="sd">            Due to the use of :meth:`guardian.shortcuts.get_objects_for_user`,</span>
<span class="sd">            it is recommended to use this method first; it does combine</span>
<span class="sd">            the existing queryset query, but it does not chain as querysets</span>
<span class="sd">            normally do.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># group permissions are only enabled when per-object permissions</span>
        <span class="c1"># are turned on</span>
        <span class="k">if</span> <span class="n">ANNOTATION_OBJECT_PERMISSIONS</span><span class="p">:</span>
            <span class="n">qs</span> <span class="o">=</span> <span class="n">get_objects_for_group</span><span class="p">(</span><span class="n">group</span><span class="p">,</span> <span class="s1">&#39;view_annotation&#39;</span><span class="p">,</span>
                                       <span class="n">get_annotation_model</span><span class="p">())</span>
            <span class="c1"># combine current queryset query, if any, with the newly</span>
            <span class="c1"># created queryset from django guardian</span>
            <span class="n">qs</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">combine</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">,</span> <span class="s1">&#39;AND&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">qs</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter</span><span class="p">()</span></div>

<div class="viewcode-block" id="AnnotationQuerySet.last_created_time"><a class="viewcode-back" href="../../codedocs.html#annotator_store.models.AnnotationQuerySet.last_created_time">[docs]</a>    <span class="k">def</span> <span class="nf">last_created_time</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Creation time of the most recently created annotation. If</span>
<span class="sd">        queryset is empty, returns None.&#39;&#39;&#39;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s1">&#39;created&#39;</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">latest</span><span class="p">(</span><span class="s1">&#39;created&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">ObjectDoesNotExist</span><span class="p">:</span>
            <span class="k">pass</span></div>

<div class="viewcode-block" id="AnnotationQuerySet.last_updated_time"><a class="viewcode-back" href="../../codedocs.html#annotator_store.models.AnnotationQuerySet.last_updated_time">[docs]</a>    <span class="k">def</span> <span class="nf">last_updated_time</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Update time of the most recently created annotation. If</span>
<span class="sd">        queryset is empty, returns None.&#39;&#39;&#39;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s1">&#39;updated&#39;</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">latest</span><span class="p">(</span><span class="s1">&#39;updated&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">ObjectDoesNotExist</span><span class="p">:</span>
            <span class="k">pass</span></div></div>


<div class="viewcode-block" id="AnnotationManager"><a class="viewcode-back" href="../../codedocs.html#annotator_store.models.AnnotationManager">[docs]</a><span class="k">class</span> <span class="nc">AnnotationManager</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Manager</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Custom :class:`~django.models.Manager` for :class:`Annotation`.</span>
<span class="sd">    Returns :class:`AnnotationQuerySet` as default queryset, and exposes</span>
<span class="sd">    :meth:`visible_to` for convenience.&#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="nf">get_queryset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">AnnotationQuerySet</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">using</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">)</span>

<div class="viewcode-block" id="AnnotationManager.visible_to"><a class="viewcode-back" href="../../codedocs.html#annotator_store.models.AnnotationManager.visible_to">[docs]</a>    <span class="k">def</span> <span class="nf">visible_to</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">):</span>
        <span class="s1">&#39;Convenience access to :meth:`AnnotationQuerySet.visible_to`&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_queryset</span><span class="p">()</span><span class="o">.</span><span class="n">visible_to</span><span class="p">(</span><span class="n">user</span><span class="p">)</span></div>

<div class="viewcode-block" id="AnnotationManager.visible_to_group"><a class="viewcode-back" href="../../codedocs.html#annotator_store.models.AnnotationManager.visible_to_group">[docs]</a>    <span class="k">def</span> <span class="nf">visible_to_group</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">group</span><span class="p">):</span>
        <span class="s1">&#39;Convenience access to :meth:`AnnotationQuerySet.visible_to_group`&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_queryset</span><span class="p">()</span><span class="o">.</span><span class="n">visible_to_group</span><span class="p">(</span><span class="n">group</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="BaseAnnotation"><a class="viewcode-back" href="../../codedocs.html#annotator_store.models.BaseAnnotation">[docs]</a><span class="nd">@six</span><span class="o">.</span><span class="n">python_2_unicode_compatible</span>
<span class="k">class</span> <span class="nc">BaseAnnotation</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Django database model to store Annotator.js annotation data,</span>
<span class="sd">    based on the</span>
<span class="sd">    `annotation format documentation &lt;http://docs.annotatorjs.org/en/v1.2.x/annotation-format.html&gt;`_.&#39;&#39;&#39;</span>

    <span class="c1">#: regex for recognizing valid UUID, for use in site urls</span>
    <span class="n">UUID_REGEX</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;[0-9a-f]</span><span class="si">{8}</span><span class="s1">-[0-9a-f]</span><span class="si">{4}</span><span class="s1">-[1-5][0-9a-f]</span><span class="si">{3}</span><span class="s1">-[89ab][0-9a-f]</span><span class="si">{3}</span><span class="s1">-[0-9a-f]</span><span class="si">{12}</span><span class="s1">&#39;</span>

    <span class="c1">#: annotation schema version: default v1.0</span>
    <span class="n">schema_version</span> <span class="o">=</span> <span class="s2">&quot;v1.0&quot;</span>
    <span class="c1"># for now, hard-coding until or unless we need to support more than</span>
    <span class="c1"># one version of annotation</span>

    <span class="c1">#: unique id for the annotation; uses :meth:`uuid.uuid4`</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">UUIDField</span><span class="p">(</span><span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">,</span> <span class="n">editable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="c1"># data model includes version, do we need to set that in the db?</span>
    <span class="c1"># &quot;annotator_schema_version&quot;: &quot;v1.0&quot;,        # schema version: default v1.0</span>

    <span class="c1">#: datetime annotation was created; automatically set when added</span>
    <span class="n">created</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DateTimeField</span><span class="p">(</span><span class="n">auto_now_add</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="c1">#: datetime annotation was last updated; automatically updated on save</span>
    <span class="n">updated</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DateTimeField</span><span class="p">(</span><span class="n">auto_now</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="c1">#: content of the annotation</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">TextField</span><span class="p">(</span><span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="c1">#: the annotated text</span>
    <span class="n">quote</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">TextField</span><span class="p">(</span><span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="c1">#: URI of the annotated document</span>
    <span class="n">uri</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">URLField</span><span class="p">()</span>
    <span class="c1">#: user who owns the annotation</span>
    <span class="c1">#: when serialized, id of annotation owner OR an object with an &#39;id&#39; property</span>
    <span class="c1"># Make user optional for now</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">AUTH_USER_MODEL</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># tags still todo</span>
    <span class="c1"># &quot;tags&quot;: [ &quot;review&quot;, &quot;error&quot; ],             # list of tags (from Tags plugin)</span>

    <span class="c1">#: any additional data included in the annotation not parsed into</span>
    <span class="c1">#: specific model fields; this includes ranges, permissions,</span>
    <span class="c1">#: annotation data, etc</span>
    <span class="n">extra_data</span> <span class="o">=</span> <span class="n">JSONField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({}))</span>
    <span class="c1"># example range from the documentation</span>
    <span class="c1"># &quot;ranges&quot;: [</span>
    <span class="c1">#     {</span>
    <span class="c1">#        &quot;start&quot;: &quot;/p[69]/span/span&quot;,           # (relative) XPath to start element</span>
    <span class="c1">#        &quot;end&quot;: &quot;/p[70]/span/span&quot;,             # (relative) XPath to end element</span>
    <span class="c1">#        &quot;startOffset&quot;: 0,                      # character offset within start element</span>
    <span class="c1">#        &quot;endOffset&quot;: 120                       # character offset within end element</span>
    <span class="c1">#    }</span>
    <span class="c1"># ]</span>

    <span class="c1"># NOTE: according to the documentation, the basic schema is</span>
    <span class="c1"># extensible, can be added to by plugins, and any fields added by the</span>
    <span class="c1"># frontend should be preserved by the backend.  Store any of that</span>
    <span class="c1"># additional information in the extra_data field.</span>

    <span class="c1">#: fields in the db model that are provided by annotation json</span>
    <span class="c1">#: when creating or updating an annotation</span>
    <span class="n">common_fields</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;text&#39;</span><span class="p">,</span> <span class="s1">&#39;quote&#39;</span><span class="p">,</span> <span class="s1">&#39;uri&#39;</span><span class="p">,</span> <span class="s1">&#39;user&#39;</span><span class="p">]</span>
    <span class="c1">#: internal fields that are not set from values provided by</span>
    <span class="c1">#: annotation json when creating or updating</span>
    <span class="n">internal_fields</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;updated&#39;</span><span class="p">,</span> <span class="s1">&#39;created&#39;</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;user&#39;</span><span class="p">,</span>
        <span class="s1">&#39;annotator_schema_version&#39;</span><span class="p">]</span>

    <span class="n">objects</span> <span class="o">=</span> <span class="n">AnnotationManager</span><span class="p">()</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">abstract</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="c1"># extend default permissions to add a view option</span>
        <span class="c1"># change_annotation and delete_annotation provided by django</span>
        <span class="n">permissions</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">(</span><span class="s1">&#39;view_annotation&#39;</span><span class="p">,</span> <span class="s1">&#39;View annotation&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;admin_annotation&#39;</span><span class="p">,</span> <span class="s1">&#39;Manage annotation&#39;</span><span class="p">),</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">text</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;&lt;Annotation: </span><span class="si">%s</span><span class="s1">&gt;&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">text</span>

<div class="viewcode-block" id="BaseAnnotation.get_absolute_url"><a class="viewcode-back" href="../../codedocs.html#annotator_store.models.BaseAnnotation.get_absolute_url">[docs]</a>    <span class="k">def</span> <span class="nf">get_absolute_url</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s1">&#39;URL to view this annotation within the annotation API.&#39;</span>
        <span class="k">return</span> <span class="n">reverse</span><span class="p">(</span><span class="s1">&#39;annotation-api:view&#39;</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">})</span></div>

<div class="viewcode-block" id="BaseAnnotation.text_preview"><a class="viewcode-back" href="../../codedocs.html#annotator_store.models.BaseAnnotation.text_preview">[docs]</a>    <span class="k">def</span> <span class="nf">text_preview</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s1">&#39;Short preview of annotation text content&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">text</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">text</span><span class="p">[:</span><span class="mi">100</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="s1">&#39;...&#39;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">text</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">100</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="c1"># provide indicator for annotations with no text</span>
        <span class="k">return</span> <span class="s1">&#39;[no text]&#39;</span></div>
    <span class="n">text_preview</span><span class="o">.</span><span class="n">short_description</span> <span class="o">=</span> <span class="s1">&#39;Text&#39;</span>

<div class="viewcode-block" id="BaseAnnotation.uri_link"><a class="viewcode-back" href="../../codedocs.html#annotator_store.models.BaseAnnotation.uri_link">[docs]</a>    <span class="k">def</span> <span class="nf">uri_link</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s1">&#39;URI as a clickable link&#39;</span>
        <span class="k">return</span> <span class="n">format_html</span><span class="p">(</span><span class="s1">&#39;&lt;a href=&quot;</span><span class="si">{}</span><span class="s1">&quot;&gt;</span><span class="si">{}</span><span class="s1">&lt;/a&gt;&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">uri</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">uri</span><span class="p">)</span></div>
    <span class="n">uri_link</span><span class="o">.</span><span class="n">short_description</span> <span class="o">=</span> <span class="s1">&#39;URI&#39;</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">related_pages</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s1">&#39;convenience access to list of related pages in extra data&#39;</span>
        <span class="k">if</span> <span class="s1">&#39;related_pages&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">extra_data</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">extra_data</span><span class="p">[</span><span class="s1">&#39;related_pages&#39;</span><span class="p">]</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">filter_data</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">internal_only</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">internal_only</span><span class="p">:</span>
            <span class="n">filter_fields</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">internal_fields</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">filter_fields</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">common_fields</span> <span class="o">+</span> <span class="bp">cls</span><span class="o">.</span><span class="n">internal_fields</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">val</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
               <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">filter_fields</span><span class="p">}</span>

<div class="viewcode-block" id="BaseAnnotation.create_from_request"><a class="viewcode-back" href="../../codedocs.html#annotator_store.models.BaseAnnotation.create_from_request">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">create_from_request</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Initialize a new :class:`Annotation` based on data from a</span>
<span class="sd">        :class:`django.http.HttpRequest`.</span>

<span class="sd">        Expects request body content to be JSON; sets annotation user</span>
<span class="sd">        based on the request user.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">decode</span><span class="p">())</span>

        <span class="n">model_data</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">extra_data</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">BaseAnnotation</span><span class="o">.</span><span class="n">common_fields</span><span class="p">:</span>
                <span class="n">model_data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">extra_data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">is_anonymous</span><span class="p">():</span>
            <span class="n">model_data</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span>

        <span class="c1"># remove any common and internal fields from extra data so they</span>
        <span class="c1"># don&#39;t get duplicated in the json field</span>
        <span class="n">extra_data</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">filter_data</span><span class="p">(</span><span class="n">extra_data</span><span class="p">)</span>

        <span class="n">annotation</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="n">extra_data</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">extra_data</span><span class="p">),</span> <span class="o">**</span><span class="n">model_data</span><span class="p">)</span>
        <span class="c1"># if extra data is present, handle any extra processing</span>
        <span class="c1"># exactly the same as when updating an annotation</span>
        <span class="k">if</span> <span class="n">annotation</span><span class="o">.</span><span class="n">extra_data</span><span class="p">:</span>
            <span class="n">annotation</span><span class="o">.</span><span class="n">extra_data</span> <span class="o">=</span> <span class="n">annotation</span><span class="o">.</span><span class="n">handle_extra_data</span><span class="p">(</span><span class="n">extra_data</span><span class="p">,</span> <span class="n">request</span><span class="p">)</span>
            <span class="n">annotation</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">annotation</span></div>

<div class="viewcode-block" id="BaseAnnotation.update_from_request"><a class="viewcode-back" href="../../codedocs.html#annotator_store.models.BaseAnnotation.update_from_request">[docs]</a>    <span class="k">def</span> <span class="nf">update_from_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Update attributes from data in a</span>
<span class="sd">        :class:`django.http.HttpRequest`. Expects request body content to be</span>
<span class="sd">        JSON.   Currently does *not* modify user.&#39;&#39;&#39;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">decode</span><span class="p">())</span>
        <span class="c1"># NOTE: could keep a list of modified fields and</span>
        <span class="c1"># and allow Django to do a more efficient db update</span>

        <span class="c1"># ignore backend-generated fields and remove so they are</span>
        <span class="c1"># not duplicated in extra data</span>
        <span class="c1"># NOTE: current implementation assumes that user should</span>
        <span class="c1"># NOT be changed after annotation is created</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter_data</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">internal_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># set database fields from data in the request</span>
        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">common_fields</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="n">field</span><span class="p">])</span>
                <span class="c1"># remove from data so it is not duplicated</span>
                <span class="k">del</span> <span class="n">data</span><span class="p">[</span><span class="n">field</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="k">pass</span>

        <span class="k">if</span> <span class="n">data</span><span class="p">:</span>
            <span class="c1"># any other data included in the request and not yet</span>
            <span class="c1"># processed should be stored as extra data.</span>
            <span class="c1"># Allow subclasses to process any extra data they care about</span>
            <span class="c1"># and then store whatever is left.</span>
            <span class="c1"># NOTE: replacing existing extra data rather than updating;</span>
            <span class="c1"># any extra data should have been included in the annotation</span>
            <span class="c1"># that was loaded for editing; using update would make it</span>
            <span class="c1"># impossible to delete extra data fields.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">extra_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">handle_extra_data</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">request</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">()</span></div>

<div class="viewcode-block" id="BaseAnnotation.handle_extra_data"><a class="viewcode-back" href="../../codedocs.html#annotator_store.models.BaseAnnotation.handle_extra_data">[docs]</a>    <span class="k">def</span> <span class="nf">handle_extra_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Handle any &quot;extra&quot; data that is not part of the stock annotation</span>
<span class="sd">        data model.  Use this method to customize the logic for creating</span>
<span class="sd">        and updating annotations from request data.</span>

<span class="sd">        NOTE: request is passed in to support permissions handling</span>
<span class="sd">        when object-level permissions are enabled.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="n">data</span></div>

<div class="viewcode-block" id="BaseAnnotation.info"><a class="viewcode-back" href="../../codedocs.html#annotator_store.models.BaseAnnotation.info">[docs]</a>    <span class="k">def</span> <span class="nf">info</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Return a :class:`collections.OrderedDict` of fields to be</span>
<span class="sd">        included in serialized JSON version of the current annotation.&#39;&#39;&#39;</span>
        <span class="n">info</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">([</span>
            <span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">)),</span>
            <span class="p">(</span><span class="s1">&#39;annotator_schema_version&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">schema_version</span><span class="p">),</span>
            <span class="c1"># iso8601 formatted dates</span>
            <span class="p">(</span><span class="s1">&#39;created&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">created</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">created</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;updated&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">updated</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">updated</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;text&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">text</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;quote&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">quote</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;uri&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">uri</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">username</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">user</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
            <span class="c1"># tags handled as part of extra data</span>
        <span class="p">])</span>
        <span class="c1"># There shouldn&#39;t be collisions between extra data and db</span>
        <span class="c1"># fields, but in case there are, none of the extra data shoudl</span>
        <span class="c1"># override core fields</span>
        <span class="n">info</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">extra_data</span><span class="p">)</span>
                     <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">info</span><span class="p">})</span>

        <span class="k">return</span> <span class="n">info</span></div>

    <span class="c1"># generic django permission checks; methods are provided for consistency</span>
    <span class="c1"># with optional per-object permissions</span>

    <span class="k">def</span> <span class="nf">user_can_view</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">user</span><span class="o">.</span><span class="n">has_perm</span><span class="p">(</span><span class="s1">&#39;annotator_store.view_annotation&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">user_can_update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">user</span><span class="o">.</span><span class="n">has_perm</span><span class="p">(</span><span class="s1">&#39;annotator_store.change_annotation&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">user_can_delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">user</span><span class="o">.</span><span class="n">has_perm</span><span class="p">(</span><span class="s1">&#39;annotator_store.delete_annotation&#39;</span><span class="p">)</span></div>


<span class="c1"># if per-object permissions are requested and guardian is installed</span>
<span class="c1"># define annotation permission functionality</span>

<span class="k">if</span> <span class="n">ANNOTATION_OBJECT_PERMISSIONS</span> <span class="ow">and</span> <span class="n">guardian</span><span class="p">:</span>

    <span class="k">class</span> <span class="nc">AnnotationWithPermissions</span><span class="p">(</span><span class="n">BaseAnnotation</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Mix-in annotation class to provide object-level permissions</span>
<span class="sd">        handling via django-guardian&#39;&#39;&#39;</span>

        <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
            <span class="n">abstract</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">permissions</span> <span class="o">=</span> <span class="p">(</span>
                <span class="p">(</span><span class="s1">&#39;view_annotation&#39;</span><span class="p">,</span> <span class="s1">&#39;View annotation&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;admin_annotation&#39;</span><span class="p">,</span> <span class="s1">&#39;Manage annotation&#39;</span><span class="p">),</span>
            <span class="p">)</span>

        <span class="c1"># example permissions from the documentation</span>
        <span class="c1"># &quot;permissions&quot;: {</span>
        <span class="c1">#     &quot;read&quot;: [&quot;group:__world__&quot;],</span>
        <span class="c1">#     &quot;admin&quot;: [],</span>
        <span class="c1">#     &quot;update&quot;: [],</span>
        <span class="c1">#     &quot;delete&quot;: []</span>
        <span class="c1"># }</span>

        <span class="c1">#: map annotator permissions to django annotation permission codenames</span>
        <span class="n">permission_to_codename</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;read&#39;</span><span class="p">:</span> <span class="s1">&#39;view_annotation&#39;</span><span class="p">,</span>
            <span class="s1">&#39;update&#39;</span><span class="p">:</span> <span class="s1">&#39;change_annotation&#39;</span><span class="p">,</span>
            <span class="s1">&#39;delete&#39;</span><span class="p">:</span> <span class="s1">&#39;delete_annotation&#39;</span><span class="p">,</span>
            <span class="s1">&#39;admin&#39;</span><span class="p">:</span> <span class="s1">&#39;admin_annotation&#39;</span>
        <span class="p">}</span>
        <span class="c1">#: lookup annotation permission mode by django permission codename</span>
        <span class="n">codename_to_permission</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([(</span><span class="n">codename</span><span class="p">,</span> <span class="n">mode</span><span class="p">)</span> <span class="k">for</span> <span class="n">mode</span><span class="p">,</span> <span class="n">codename</span>
                                       <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="n">permission_to_codename</span><span class="p">)])</span>

        <span class="k">def</span> <span class="nf">info</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="sd">&#39;&#39;&#39;Update default annotation info to include permissions&#39;&#39;&#39;</span>
            <span class="n">info</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">AnnotationWithPermissions</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">info</span><span class="p">()</span>
            <span class="c1"># annotation permissions dict based on database permissions</span>
            <span class="n">permissions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">permissions_dict</span><span class="p">()</span>
            <span class="c1"># only include if at least one permission is not empty</span>
            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">permissions</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
                <span class="n">info</span><span class="p">[</span><span class="s1">&#39;permissions&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">permissions</span>
            <span class="k">return</span> <span class="n">info</span>

        <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;Extend default save method to ensure annotation user has</span>
<span class="sd">            access to edit and update their own annotation.&quot;&quot;&quot;</span>
            <span class="nb">super</span><span class="p">(</span><span class="n">AnnotationWithPermissions</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="c1"># NOTE: currently annotation model assumes user is not modified;</span>
            <span class="c1"># if it is changed, previous owner will still have permissions</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">grant_user_access</span><span class="p">()</span>

        <span class="k">def</span> <span class="nf">handle_extra_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
            <span class="sd">&#39;&#39;&#39;Handle any &quot;extra&quot; data that is not part of the stock annotation</span>
<span class="sd">            data model.  Use this method to customize the logic for updating</span>
<span class="sd">            an annotation from request data.&#39;&#39;&#39;</span>
            <span class="n">data</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">AnnotationWithPermissions</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">handle_extra_data</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">request</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;permissions&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
                <span class="c1"># only change permissions if user has admin annotation</span>
                <span class="c1"># permission; otherwise, ignore any changes</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_has_perm</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">,</span> <span class="s1">&#39;admin_annotation&#39;</span><span class="p">):</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;user has admin perms, updating db permissions&#39;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">db_permissions</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;permissions&#39;</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;user does not have admin perms, ignoring permissions&#39;</span><span class="p">)</span>

                <span class="c1"># remove permissions from extra data so it does not</span>
                <span class="c1"># get stored in the catch-all json field</span>
                <span class="k">del</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;permissions&#39;</span><span class="p">]</span>

            <span class="k">return</span> <span class="n">data</span>

        <span class="k">def</span> <span class="nf">user_permissions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="sd">&#39;&#39;&#39;Queryset of :class:`guardian.model.UserObjectPermission`</span>
<span class="sd">            objects associated with this annotation.&#39;&#39;&#39;</span>
            <span class="k">return</span> <span class="n">UserObjectPermission</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">object_pk</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pk</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">group_permissions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="sd">&#39;&#39;&#39;Queryset of :class:`guardian.model.GroupObjectPermission`</span>
<span class="sd">            objects associated with this annotation.&#39;&#39;&#39;</span>
            <span class="k">return</span> <span class="n">GroupObjectPermission</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">object_pk</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pk</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">get_group_or_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ident</span><span class="p">):</span>
            <span class="c1"># look up annotation group or user based on username</span>
            <span class="c1"># or group id in annotation permissions list</span>
            <span class="k">if</span> <span class="n">ident</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;group:&#39;</span><span class="p">):</span>
                <span class="n">group_id</span> <span class="o">=</span> <span class="n">ident</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="s1">&#39;group:&#39;</span><span class="p">):]</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">AnnotationGroup</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">group_id</span><span class="p">))</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="c1"># non-integer identifier found</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Invalid group id &#39;</span><span class="si">%s</span><span class="s2">&#39; in annotation </span><span class="si">%s</span><span class="s2"> permissions&quot;</span><span class="p">,</span>
                                <span class="n">group_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pk</span><span class="p">)</span>
                <span class="k">except</span> <span class="n">AnnotationGroup</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Error finding group &#39;</span><span class="si">%s</span><span class="s2">&#39; in annotation </span><span class="si">%s</span><span class="s2"> permissions&quot;</span><span class="p">,</span>
                                <span class="n">group_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pk</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="n">ident</span><span class="p">)</span>
                <span class="k">except</span> <span class="n">User</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Error finding user &#39;</span><span class="si">%s</span><span class="s2">&#39; in annotation </span><span class="si">%s</span><span class="s2"> permissions&quot;</span><span class="p">,</span>
                                <span class="n">ident</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pk</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">assign_permission</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">permission</span><span class="p">,</span> <span class="n">entity</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;Wrapper around :meth:`guardian.shortcuts.assign_perm`.</span>
<span class="sd">            Gives the specified permission to the specified user or group</span>
<span class="sd">            on the current object.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">assign_perm</span><span class="p">(</span><span class="n">permission</span><span class="p">,</span> <span class="n">entity</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">db_permissions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">permissions</span><span class="p">):</span>
            <span class="sd">&#39;&#39;&#39;Convert annotation permission data into actionable</span>
<span class="sd">            django permissions using :mod:`guardian` per-object permissions.</span>
<span class="sd">            &#39;&#39;&#39;</span>
            <span class="c1"># since there is no way to know what permissions were</span>
            <span class="c1"># previously in place and need to be removed, remove all permissions</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">user_permissions</span><span class="p">()</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">group_permissions</span><span class="p">()</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>

            <span class="c1"># NOTE: should eventually handle special case</span>
            <span class="c1"># group:__world__, but setting that is currently not supported</span>
            <span class="c1"># by the readux annotator permissions module</span>

            <span class="c1"># then re-assign permissions based on annotation permissions</span>
            <span class="k">for</span> <span class="n">mode</span><span class="p">,</span> <span class="n">users</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="n">permissions</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">ident</span> <span class="ow">in</span> <span class="n">users</span><span class="p">:</span>
                    <span class="n">entity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_group_or_user</span><span class="p">(</span><span class="n">ident</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">entity</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="c1"># give user/group the appropriate permission on this object</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">assign_permission</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">permission_to_codename</span><span class="p">[</span><span class="n">mode</span><span class="p">],</span>
                                               <span class="n">entity</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">grant_user_access</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">user</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>   <span class="c1"># possibly also check anonymous?</span>
                <span class="k">for</span> <span class="n">perm</span> <span class="ow">in</span> <span class="n">get_perms_for_model</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                    <span class="c1"># skip default django add permission - not relevant</span>
                    <span class="c1"># on an individual object</span>
                    <span class="k">if</span> <span class="n">perm</span><span class="o">.</span><span class="n">codename</span> <span class="o">==</span> <span class="s1">&#39;add_annotation&#39;</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">assign_permission</span><span class="p">(</span><span class="n">perm</span><span class="o">.</span><span class="n">codename</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">permissions_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="sd">&#39;&#39;&#39;Convert stored :mod:`guardian` per-object permissions into</span>
<span class="sd">            annotation permission dictionary format&#39;&#39;&#39;</span>
            <span class="c1"># convert db permissions into annotator style permissions</span>

            <span class="c1"># construct base permissions dict, empty list for each mode</span>
            <span class="n">permissions</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([(</span><span class="n">mode</span><span class="p">,</span> <span class="p">[])</span>
                               <span class="k">for</span> <span class="n">mode</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">permission_to_codename</span><span class="o">.</span><span class="n">keys</span><span class="p">()])</span>

            <span class="k">for</span> <span class="n">user_perm</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_permissions</span><span class="p">():</span>
                <span class="c1"># convert db codename to annotation mode</span>
                <span class="n">mode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">codename_to_permission</span><span class="p">[</span><span class="n">user_perm</span><span class="o">.</span><span class="n">permission</span><span class="o">.</span><span class="n">codename</span><span class="p">]</span>
                <span class="c1"># store by username</span>
                <span class="n">permissions</span><span class="p">[</span><span class="n">mode</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">user_perm</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">username</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">group_perm</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">group_permissions</span><span class="p">():</span>
                <span class="n">mode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">codename_to_permission</span><span class="p">[</span><span class="n">group_perm</span><span class="o">.</span><span class="n">permission</span><span class="o">.</span><span class="n">codename</span><span class="p">]</span>
                <span class="n">permissions</span><span class="p">[</span><span class="n">mode</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">group_perm</span><span class="o">.</span><span class="n">group</span><span class="o">.</span><span class="n">annotationgroup</span><span class="o">.</span><span class="n">annotation_id</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">permissions</span>

        <span class="k">def</span> <span class="nf">user_has_perm</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">permission</span><span class="p">):</span>
            <span class="s1">&#39;Check if a user has a specific permission on this object.&#39;</span>
            <span class="c1"># NOTE: according to guardian docs, it should work to use this</span>
            <span class="c1"># user.has_perm(permission, self)</span>
            <span class="c1"># but that check fails when it should not.</span>
            <span class="k">return</span> <span class="n">permission</span> <span class="ow">in</span> <span class="n">get_perms</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">user_can_view</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_has_perm</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="s1">&#39;view_annotation&#39;</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">user_can_update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_has_perm</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="s1">&#39;change_annotation&#39;</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">user_can_delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_has_perm</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="s1">&#39;delete_annotation&#39;</span><span class="p">)</span>


    <span class="k">class</span> <span class="nc">AnnotationGroup</span><span class="p">(</span><span class="n">Group</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Annotation Group; extends :class:`django.contrib.auth.models.Group`.</span>

<span class="sd">        Intended to facilitate group permissions on annotations.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># inherits name from Group</span>
        <span class="c1">#: optional notes field</span>
        <span class="n">notes</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">TextField</span><span class="p">(</span><span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1">#: datetime annotation was created; automatically set when added</span>
        <span class="n">created</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DateTimeField</span><span class="p">(</span><span class="n">auto_now_add</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1">#: datetime annotation was last updated; automatically updated on save</span>
        <span class="n">updated</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DateTimeField</span><span class="p">(</span><span class="n">auto_now</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">num_members</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_set</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
        <span class="n">num_members</span><span class="o">.</span><span class="n">short_description</span> <span class="o">=</span> <span class="s1">&#39;# members&#39;</span>

        <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">return</span> <span class="s1">&#39;&lt;Annotation Group: </span><span class="si">%s</span><span class="s1">&gt;&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>

        <span class="nd">@property</span>
        <span class="k">def</span> <span class="nf">annotation_id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">return</span> <span class="s1">&#39;group:</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">pk</span>


<span class="c1"># if default annotation model is requested, define it here</span>
<span class="c1"># otherwise, custom annotation model will be used</span>
<span class="k">if</span> <span class="n">ANNOTATION_MODEL_NAME</span> <span class="o">==</span> <span class="s2">&quot;annotator_store.Annotation&quot;</span><span class="p">:</span>

    <span class="k">if</span> <span class="n">ANNOTATION_OBJECT_PERMISSIONS</span> <span class="ow">and</span> <span class="n">guardian</span><span class="p">:</span>

        <span class="k">class</span> <span class="nc">Annotation</span><span class="p">(</span><span class="n">AnnotationWithPermissions</span><span class="p">):</span>
                <span class="k">pass</span>

    <span class="k">else</span><span class="p">:</span>
<div class="viewcode-block" id="Annotation"><a class="viewcode-back" href="../../codedocs.html#annotator_store.models.Annotation">[docs]</a>        <span class="k">class</span> <span class="nc">Annotation</span><span class="p">(</span><span class="n">BaseAnnotation</span><span class="p">):</span>
            <span class="k">pass</span></div>


<span class="k">def</span> <span class="nf">get_annotation_model</span><span class="p">():</span>
    <span class="n">app_name</span><span class="p">,</span> <span class="n">model_name</span> <span class="o">=</span> <span class="n">ANNOTATION_MODEL_NAME</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)</span>
    <span class="n">app</span> <span class="o">=</span> <span class="n">apps</span><span class="o">.</span><span class="n">get_app_config</span><span class="p">(</span><span class="n">app_name</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">app</span><span class="o">.</span><span class="n">get_model</span><span class="p">(</span><span class="n">model_name</span><span class="p">)</span>


</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<p class="logo">
  <a href="../../index.html">
    <img class="logo" src="../../_static/readux.png" alt="Logo"/>
    
  </a>
</p>



<p class="blurb">Django application to act as an annotator.js 2.x annotator-store backend</p>




<p>
<iframe src="https://ghbtns.com/github-btn.html?user=Princeton-CDH&repo=django-annotator-store&type=watch&count=true&size=large&v=2"
  allowtransparency="true" frameborder="0" scrolling="0" width="200px" height="35px"></iframe>
</p>





    

<p>
<a href="https://travis-ci.org/Princeton-CDH/django-annotator-store">
    <img
        alt="https://secure.travis-ci.org/Princeton-CDH/django-annotator-store.svg?branch=master"
        src="https://secure.travis-ci.org/Princeton-CDH/django-annotator-store.svg?branch=master"
    />
</a>
</p>


<h3>Navigation</h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../codedocs.html">Code Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../changelog.html">Version History</a></li>
</ul>


<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script><div class="lits">
<p>Powered by:</p>
<a href="http://it.emory.edu/">
<img src="../../_static/LITS-logo-bk.png" alt="Emory LITS" />
</a>

<div class="ecds-logo">
<a href="http://digitalscholarship.emory.edu/">
    <img src="../../_static/ECDS-logo.png" alt="ECDS" />
    <span>Emory Center for Digital Scholarship</span>
    </a>
</div>


</div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2017, CDH @ Princeton University.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.6.2</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.10</a>
      
    </div>

    

    
  </body>
</html>