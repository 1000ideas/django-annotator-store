{% extends 'site_base.html' %}
{% load static widget_tweaks readux_utils %}


{% block page-subtitle %}{{ vol.display_label }} | Export {% endblock %}

{% block javascript %}
  {{ block.super }}
   <script type="text/javascript" src="{% static 'ext/js.cookie.js' %}"></script>
   <script type="text/javascript" src="{% static 'ext/moment.min.js' %}"></script>
  <script type="text/javascript" src="//emory-lits-labs.github.io/annotator-meltdown-zotero/build/0.1.0/annotator.meltdown.zotero.min.js"></script> <!-- includes jquery-ui autocomplete -->
  <link rel="stylesheet" type="text/css" href="//emory-lits-labs.github.io/annotator-meltdown-zotero/build/0.1.0/annotator.meltdown.zotero.min.css" />
  <link rel="stylesheet" type="text/css" href="{% static 'css/volume_export.css' %}" />
{% endblock %}

{% block content %}
<div class="container">

    {% include 'books/snippets/volume_header.html' %}

    <div class="status" style="display:none">
        <div class="alert alert-info">Your export has been requested.  Please leave
        this page open to be notified when it is complete.</div>
        <div class="updates"></div>
    </div>

    {% if user.is_anonymous %}
      {# display a warning to users who are not logged in #}
      <div class="alert alert-warning">Export functionality is only available
      to logged in users.</div>

      <p>To export an annotated edition of this volume or any other,
      please log in.</p>
    {% else %}
    {% if warning %}
    <div class="alert alert-warning">
      <i class="fa fa-exclamation-triangle" aria-hidden="true"></i>
      {{ warning }}</div>
    {% endif %}

    <div id="github-export" style="display:none">
    {# github export success message; displayed & urls populated by javascript #}
      <div class="alert alert-success">GitHub jekyll site export succeeded.</div>

      <p>Your website export has been generated and saved to a new
      GitHub repository at <a class="repo-url"></a>.
      Your annotated web edition should now be accessible via GitHub Pages
      at <a class="ghpages-url"></a>.</p>

      <p>For more information on using and customizing your site,
      see the
      <a href="https://help.github.com/categories/github-pages-basics/">Github
      Pages help documentation</a>.</p>
    </div>

    <div id="github-update" style="display:none">
    {# github update success message; displayed & urls populated by javascript #}
      <div class="alert alert-success">GitHub jekyll site update succeeded.</div>

      <p>A new <a class="pullrequest-url">pull request</a> has been created
      on your <a class="repo-url">GitHub repository</a> with all the latest
      changes.  You can review the changes and merge them into your
      published edition.</p>
    </div>

    <form class="volume-webexport form-horizontal">{% csrf_token %}
      {{ export_form.non_field_errors }}
      {# include volume pid as a hidden field so it is included in websocket form submission #}
      <input type="hidden" name="pid" value="{{ vol.pid }}"/>
    {% for field in export_form %}
    {# TODO: github options should be disabled if user does not have a github account #}
    {# TODO: add visual indication for disabled fields #}
          {% if field.name = 'mode' %}
          {# special handling for export mode radio buttons and help text #}
          <div class="help-block">{{ field.help_text}}</div>
          {% for radio in field %}
            <div class="radio">
              <label for="{{ radio.id_for_label }}">
                  {{ radio.tag }} {{ radio.choice_label}}
              </label>
              {% with forloop.counter|cut:' ' as index %}
                <div class="help-block">{{ export_form.mode_help|slice:index|last }}</div>
              {% endwith %}
            </div>
          {% endfor %}
          <div class="text-warning mode-errors">{{ field.errors }}</div>

          {% elif field.name = 'annotations' and export_form.hide_annotation_choice %}
          {# hide annotation choice when flag is set (i.e., only one choice available) #}
            {{ field|add_class:"hidden" }}
          {% else %}
        <div class="form-group{% if field.errors %} has-error{% endif %}"{% if field.name = 'github_repo' or field.name = 'update_repo' %}style="display:none"{% endif %}>
            <label for="{{ field.name }}">{{ field.label }}</label>
            {{ field|add_class:"form-control" }}
            <div class="help-block">{{ field.help_text}}</div>
            <div class="text-warning {{ field.name }}-errors">{{ field.errors }}</div>
            {# TODO: display validation errors, required/optional ? #}
        </div>
        {% endif %}
        {% endfor %}

        <div class="form-group">
          <button type="submit" class="volume-export btn btn-default">Export</button>
        </div>
    </form>


    <script>
    {# Show/hide subportions of the form based on export mode #}
      $(document).ready(function(){
        var transition = 500;
        var github_repo = $("div.form-group:has(#id_github_repo)");
        var update_repo = $("div.form-group:has(#id_update_repo)");
        $("input[type=radio][name=mode]").change(function() {
          // hide everything by default, then show as appropriate by mode
          github_repo.hide(transition);
          update_repo.hide(transition);
          if (this.value == 'github') {
            github_repo.show(transition);
          } else if (this.value == 'github_update') {
            update_repo.show(transition);
          }
        });

        // load github repo data once, and use as variable data source
        // for the update repository autocomplete input
        $.getJSON("{% url 'accounts:github-repos' %}", function( data ) {
            $("#id_update_repo").autocomplete({
                source: data
            });
        });

      // Note that the path doesn't currently matter for routing; any WebSocket
      // connection gets bumped over to WebSocket consumers
      socket = new WebSocket("ws://" + window.location.host + "/notify/");
      socket.onmessage = function(e) {
          var message, data = {};
          try {
            // try to parse message data as json
            data = JSON.parse(e.data);
            message = data.message;
          } catch (err) {
            // if json parse errors, assume message is plain text
            message = e.data;
          }
          if (data.type == 'error') {
              // clear out status messages
              // $('.status').empty();   // maybe better to hide/collapse progress?
              // show the error
              $('.status').append($('<div class="alert alert-warning">').text(message));
              // redisplay the form, in case user wants to resubmit
              $('.volume-webexport').show();
          } else {
              // todo: maybe also display time, so it looks more like a log?
              // needs CSS, and maybe made collapsible (bootstrap collapse?)
              var now = new moment(), p = $('<p>');
              p.append($('<span class="time text-muted">')
                .text(now.format("HH:mm:ss")));
              p.append($('<span>').text(message));
              $('.status .updates').append(p);
          }
          // *** special cases ***

          // form was invalid, redisplay form with errors
          if (data.form_errors) {
            for (var field in data.form_errors) {
              // update existing field error field with text from validation
              $('.' + field + '-errors').text(data.form_errors[field]);
            }
          } else if (data.github_export) {
            // github export completed
            var div = $('#github-export');
            // set repo url and github pages links
            div.find('.repo-url').attr('href', data.repo_url).text(data.repo_url);
            div.find('.ghpages-url').attr('href', data.ghpages_url).text(data.ghpages_url)
            div.show()
          } else if (data.github_update) {
            // github update completed
            var div = $('#github-update');
            // set repo url and pull request links
            div.find('.repo-url').attr('href', data.repo_url);
            div.find('.pullrequest-url').attr('href', data.pullrequest_url);
            div.show()
          }
      }

        $('.volume-webexport').submit(function(event) {
          console.log(this)
          var $this = $(this);
          console.log(event);
          // submit form data as json over the websocket
          socket.send(JSON.stringify({
              volume_export: $this.serialize()
          }));
          // hide the form
          $this.hide();
          // don't submit via normal means
          event.preventDefault();
          // clear then show the status box
          // $('.status').empty();
          $('.status').show()
        });

      });
    </script>

  {% endif %}  {# logged in user #}

    </div>
{% endblock %}
